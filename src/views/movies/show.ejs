<%- include('../partials/header') %>
<link rel="stylesheet" href="/css/movies.css">

<div class="container">
    <div class="movie-details">
        <div class="movie-poster">
            <img src="<%= movie.poster %>" alt="<%= movie.title %>">
        </div>
        <div class="movie-info">
            <h1><%= movie.title %></h1>
            <p class="movie-type"><%= movie.type %></p>
            <p class="movie-description"><%= movie.description %></p>
            
            <div class="movie-servers">
                <h3>Watch Online</h3>
                <div class="server-selector">
                    <label for="server-select">Select a server to watch:</label>
                    <select id="server-select" class="server-select">
                        <option value="">Choose a server</option>
                        <% servers.forEach((server, index) => { %>
                            <option value="<%= index %>"><%= server.server_name %></option>
                        <% }); %>
                    </select>
                </div>
                <% servers.forEach((server, index) => { %>
                    <div class="server-option" id="server-<%= index %>" style="display: none;">
                        <h4><%= server.server_name %></h4>
                        <div class="embed-container">
                            <iframe src="<%= server.embed_url %>" allowfullscreen></iframe>
                        </div>
                    </div>
                <% }); %>
            </div>

            <div class="movie-reviews">
                <h3>Reviews</h3>
                <% if (user) { %>
                    <form action="/movies/<%= movie.id %>/review" method="POST" class="review-form">
                        <div class="form-group">
                            <label for="rating">Rating</label>
                            <select name="rating" id="rating" required>
                                <option value="5">5 Stars</option>
                                <option value="4">4 Stars</option>
                                <option value="3">3 Stars</option>
                                <option value="2">2 Stars</option>
                                <option value="1">1 Star</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="comment">Comment</label>
                            <textarea name="comment" id="comment" required></textarea>
                        </div>
                        <button type="submit" class="btn">Submit Review</button>
                    </form>
                <% } %>

                <div class="reviews-list">
                    <% reviews.forEach(review => { %>
                        <div class="review">
                            <div class="review-header">
                                <span class="review-author"><%= review.username %></span>
                                <span class="review-rating"><%= review.rating %> stars</span>
                            </div>
                            <p class="review-comment"><%= review.comment %></p>
                            <small class="review-date">
                                <%= new Date(review.created_at).toLocaleDateString() %>
                            </small>
                        </div>
                    <% }); %>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('server-select').addEventListener('change', function() {
    // Hide all server options
    document.querySelectorAll('.server-option').forEach(el => el.style.display = 'none');
    
    // Show selected server
    const selectedServer = this.value;
    if (selectedServer !== '') {
        document.getElementById('server-' + selectedServer).style.display = 'block';
    }
});
</script>

<%- include('../partials/footer') %>