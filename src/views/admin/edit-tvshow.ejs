<%- include('../partials/header') %>
<link rel="stylesheet" href="/css/add-tvshow.css">

<div class="form-container">
  <h2>Edit TV Show</h2>
  <% if (locals.error) { %>
    <div class="alert alert-error"><%= error %></div>
  <% } %>
  <form action="/admin/tvshows/edit/<%= tvshow.id %>" method="POST" enctype="multipart/form-data">
    <div class="form-group">
      <label for="title">Title</label>
      <input type="text" id="title" name="title" value="<%= tvshow.title %>" required>
    </div>
    <div class="form-group">
      <label for="poster">Poster (1200x1809)</label>
      <input type="file" id="poster" name="poster" accept="image/jpeg,image/png">
      <small>Leave empty to keep current poster</small>
    </div>
    <div class="form-group">
      <label for="description">Description</label>
      <textarea id="description" name="description" rows="4" required><%= tvshow.description %></textarea>
    </div>
    <div class="form-group">
      <label for="seasons">Number of Seasons</label>
      <input type="number" id="seasons" name="seasons" min="1" value="<%= tvshow.seasons %>" required>
    </div>
    
    <div id="episodes-container">
      <h3>Episodes</h3>
      <% episodes.forEach((episode, index) => { %>
        <div class="episode-entry" data-season="<%= episode.season %>">
          <h4>Season <%= episode.season %> Episode <%= episode.episode %></h4>
          <input type="hidden" name="episodes[<%= index %>][id]" value="<%= episode.id %>">
          <input type="hidden" name="episodes[<%= index %>][season]" value="<%= episode.season %>">
          <input type="hidden" name="episodes[<%= index %>][number]" value="<%= episode.episode %>">
          
          <div id="episode-<%= episode.id %>-servers">
            <% episode.servers.forEach((server, serverIndex) => { %>
              <div class="server-entry">
                <div class="form-group">
                  <label>Server <%= serverIndex + 1 %></label>
                  <input type="text" name="episodes[<%= index %>][servers][<%= serverIndex %>][name]" value="<%= server.server_name %>" placeholder="Server name" required>
                  <input type="text" name="episodes[<%= index %>][servers][<%= serverIndex %>][url]" value="<%= server.embed_url %>" placeholder="Embed URL" required>
                </div>
              </div>
            <% }); %>
          </div>
          <button type="button" class="btn" onclick="addServer('<%= episode.id %>', <%= index %>)">Add Server</button>
          <button type="button" class="btn btn-danger" onclick="deleteLastServer('<%= episode.id %>')">Delete Last Server</button>
        </div>
      <% }); %>
    </div>
    
    <button type="button" class="btn" onclick="addEpisode()">Add Episode</button>
    <button type="button" class="btn btn-danger" onclick="deleteLastEpisode()">Delete Last Episode</button>
    <button type="button" class="btn btn-danger" onclick="deleteLastSeason()">Delete Last Season</button>
    <button type="submit" class="btn">Update TV Show</button>
  </form>
</div>

<script>
let episodeCount = <%= episodes.length %>;
let seasonCount = <%= tvshow.seasons %>;

function addEpisode() {
  const season = document.getElementById('seasons').value;
  const container = document.getElementById('episodes-container');
  
  const seasonEpisodes = Array.from(container.children)
    .filter(el => el.dataset.season === season);
  const lastEpisodeNumber = seasonEpisodes.length + 1;
  
  const episodeDiv = document.createElement('div');
  episodeDiv.className = 'episode-entry';
  episodeDiv.dataset.season = season;
  
  episodeDiv.innerHTML = `
    <h4>Season ${season} Episode ${lastEpisodeNumber}</h4>
    <input type="hidden" name="episodes[${episodeCount}][season]" value="${season}">
    <input type="hidden" name="episodes[${episodeCount}][number]" value="${lastEpisodeNumber}">
    <div id="episode-new-${episodeCount}-servers">
      <div class="server-entry">
        <div class="form-group">
          <label>Server 1</label>
          <input type="text" name="episodes[${episodeCount}][servers][0][name]" placeholder="Server name" required>
          <input type="text" name="episodes[${episodeCount}][servers][0][url]" placeholder="Embed URL" required>
        </div>
      </div>
    </div>
    <button type="button" class="btn" onclick="addServer('new-${episodeCount}', ${episodeCount})">Add Server</button>
    <button type="button" class="btn btn-danger" onclick="deleteLastServer('new-${episodeCount}')">Delete Last Server</button>
  `;
  
  container.appendChild(episodeDiv);
  episodeCount++;
}

function addServer(episodeId, episodeIndex) {
  const container = document.getElementById(`episode-${episodeId}-servers`);
  const serverCount = container.children.length;
  const serverDiv = document.createElement('div');
  serverDiv.className = 'server-entry';
  serverDiv.innerHTML = `
    <div class="form-group">
      <label>Server ${serverCount + 1}</label>
      <input type="text" name="episodes[${episodeIndex}][servers][${serverCount}][name]" placeholder="Server name" required>
      <input type="text" name="episodes[${episodeIndex}][servers][${serverCount}][url]" placeholder="Embed URL" required>
    </div>
  `;
  container.appendChild(serverDiv);
}

function deleteLastServer(episodeId) {
  const container = document.getElementById(`episode-${episodeId}-servers`);
  if (container.children.length > 1) {
    container.removeChild(container.lastChild);
  }
}

function deleteLastEpisode() {
  const container = document.getElementById('episodes-container');
  if (container.children.length > 0) {
    container.removeChild(container.lastChild);
    episodeCount--;
  }
}

function deleteLastSeason() {
  if (seasonCount > 1) {
    const container = document.getElementById('episodes-container');
    const episodes = Array.from(container.children);
    const lastSeason = seasonCount;
    
    episodes.forEach(episode => {
      if (parseInt(episode.dataset.season) === lastSeason) {
        container.removeChild(episode);
      }
    });
    
    seasonCount--;
    document.getElementById('seasons').value = seasonCount;
  }
}
</script>

<%- include('../partials/footer') %>